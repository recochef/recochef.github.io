<!DOCTYPE html>
<html lang="en">

<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5F9Y9HC95G"></script>
      <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "G-5F9Y9HC95G");
      </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="Neural Matrix Factorization from scratch in PyTorch">
    <meta property="og:type" content="blog">
  <title>Neural Matrix Factorization from scratch in PyTorch</title>
<link rel="icon" type="image/png" href="./favicon.png"/>
  <!-- Favicon -->
    <link rel="shortcut icon" target="_blank" href="ðŸŒ€">
    <link rel="stylesheet" type="text/css" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index">
      <div class="Navbar__Btn"><span>ðŸŒ€</span> <span>Home</span></div>
    </a>
                                                                                                                                                                              </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">Neural Matrix Factorization from scratch in PyTorch</h1>
            <div class="DateTagBar">
                <span class="DateTagBar__Item DateTagBar__Date">Posted on Tue, Mar 2, 2021</span>
                            </div>
          </header>
      <article id="https://www.notion.so/5b3f7307a468435e903057dadb5a36b1" class="PageRoot"><div id="https://www.notion.so/194f975b1abd4bfbb6f24af5915bac76" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">A tutorial to understand the process of building aÂ </span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Neural Matrix Factorization</strong></span><span class="SemanticString">Â model from scratch in PyTorch on MovieLens-1M dataset.</span></span></p></div><h2 id="https://www.notion.so/a78879fce0d1459b999ea23e1a6b3899" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/a78879fce0d1459b999ea23e1a6b3899"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Dataset</strong></span></span></h2><div id="https://www.notion.so/8b57e5b7059641b78e7c4dbe46f0a8c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">After downloading and expanding the movielens-1m dataset, we will create the dataset class as the first step:</span></span></p></div><div id="https://www.notion.so/6e645252fd274d208c3fbca3b272bade" class="Image Image--Normal"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb0432315-a969-48b0-883e-46465322d172%2FUntitled.png?width=450&amp;table=block&amp;id=6e645252-fd27-4d20-8c3f-bca3b272bade"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fb0432315-a969-48b0-883e-46465322d172%2FUntitled.png?width=450&amp;table=block&amp;id=6e645252-fd27-4d20-8c3f-bca3b272bade" style="width:450px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/beb0485ba03e4dcaa6b3bc61684ddb08" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The name of our class isÂ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Rating_Dataset</em></span><span class="SemanticString">Â and it is getting inherited from PyTorch</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">Â Dataset</em></span><span class="SemanticString">Â base class. TheÂ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">__getitem__</em></span><span class="SemanticString">Â method is helping us in 2 ways: 1) It is reinforcing the type to [long, long, float] and returning the tensor version of the tuple for the given index id.</span></span></p></div><div id="https://www.notion.so/91553b35e5c648c585e52f42246acab7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We are also creating a helper dataset class to put all the data processing functions under a single umbrella. This class contains 5 methods:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/a52699643aa747f4b4d4c5b071b7a609" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">_reindex</em></span><span class="SemanticString">: process dataset to reindex userID and itemID, also set rating as binary feedback</span></span></li><li id="https://www.notion.so/a872090d08ee4c068bc530cf6e143537" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">_leave_one_out</em></span><span class="SemanticString">: leave-one-out evaluation protocol in paperÂ </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://www.comp.nus.edu.sg/~xiangnan/papers/ncf.pdf">https://www.comp.nus.edu.sg/~xiangnan/papers/ncf.pdf</a></span></span></li><li id="https://www.notion.so/cee9fe8cee114fe6b018f35909c389a8" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">_negative_sampling</em></span><span class="SemanticString">: randomly selects n negative examples for each positive one</span></span></li><li id="https://www.notion.so/98a0ba3b976243dbbdc6c5ce6604d881" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">get_train_instance</em></span><span class="SemanticString">: merge the examples of train data with negative samples and return the PyTorch dataloader object</span></span></li><li id="https://www.notion.so/321c870dd11d4b699d499b083955c196" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">get_test_instance</em></span><span class="SemanticString">: merge the examples of test data with negative samples and return the PyTorch dataloader object</span></span></li></ul><h2 id="https://www.notion.so/38d3d9b435794f82b32496aa9c0715a6" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/38d3d9b435794f82b32496aa9c0715a6"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Evaluation criteria</strong></span></span></h2><div id="https://www.notion.so/8424c64f633a42dcbaa53e3009b7ba93" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Next, we are defining evaluation metrics.</span></span></p></div><div id="https://www.notion.so/e8bc40b65f1641d180d64896d09b09a1" class="Image Image--Normal"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3cec4960-0e91-4ac9-b1f8-18afa3cfb1a1%2FUntitled.png?width=372&amp;table=block&amp;id=e8bc40b6-5f16-41d1-80d6-4896d09b09a1"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3cec4960-0e91-4ac9-b1f8-18afa3cfb1a1%2FUntitled.png?width=372&amp;table=block&amp;id=e8bc40b6-5f16-41d1-80d6-4896d09b09a1" style="width:372px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/9a0c350440f24732b513bc1e875b399e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">TheÂ </span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">metricsÂ </em></span><span class="SemanticString">function is first loading the user and item variables to the right device (e.g. to the GPU if it is enabled), then getting predictions from the model and then finally calculating (&amp; returning) the hit_rate_at_k and ndcg_at_k values.</span></span></p></div><h2 id="https://www.notion.so/22f04bd2f6c84fda8c83b9825b5cff7b" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/22f04bd2f6c84fda8c83b9825b5cff7b"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Neural Collaborative Filtering for Personalized Ranking</strong></span></span></h2><div id="https://www.notion.so/b51fa723deb848d7a70275477bc42095" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">This model leverages the flexibility and non-linearity of neural networks to replace dot products of matrix factorization, aiming at enhancing the model expressiveness. In specific, this model is structured with two subnetworks including generalized matrix factorization (GMF) and MLP and models the interactions from two pathways instead of simple inner products. The outputs of these two networks are concatenated for the final prediction scores calculation.</span></span></p></div><div id="https://www.notion.so/7e3b947b120843f3900a293b7fca2888" class="Image Image--Normal"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F725eb7a6-e65d-4fe2-a655-889ac41cfd6b%2FUntitled.png?width=591&amp;table=block&amp;id=7e3b947b-1208-43f3-900a-293b7fca2888"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F725eb7a6-e65d-4fe2-a655-889ac41cfd6b%2FUntitled.png?width=591&amp;table=block&amp;id=7e3b947b-1208-43f3-900a-293b7fca2888" style="width:591px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/bf1088be2c3a406685cd0ebf1ceeeca6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">After defining the dataset class and evaluation function, it is time to define the model architecture.</span></span></p></div><div></div><div id="https://www.notion.so/78ae7d834bf54c3db7052b87498c3641" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">In this architecture, we are first creating the user and item embedding layers for both MLP and MF architectures, and with the help of PyTorchÂ </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://pytorch.org/docs/stable/generated/torch.nn.ModuleList">ModuleList</a></span><span class="SemanticString">, we are creating MLP architecture. Then, in the forward method, we are passing user and item indices list in the embedding layers and then concatenating and multiplying the MLP and MF embedding layers respectively. And finally, concatenating the MLP and MF feature layers and a logistic activation at the end.</span></span></p></div><h2 id="https://www.notion.so/a09f9ec6123d4695aa3d34224a9565ac" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/a09f9ec6123d4695aa3d34224a9565ac"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Training and evaluation</strong></span></span></h2><div id="https://www.notion.so/d9ef5e3ba93c4906a51f1f490e9a531d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We are using following hyperparameters to train the model:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e1162cc273c14365b59591c466b62cd0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Learning rate is 0.001</span></span></li><li id="https://www.notion.so/bdf4e5d7450c49b6999d1e78535ac101" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Dropout rate is 0.2</span></span></li><li id="https://www.notion.so/8cbbe3b743ce44f393ed0780614a8dc1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Running for 10 epochs</span></span></li><li id="https://www.notion.so/385cf8caadf2421aa84dc4a06c68f4cc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">HitRate@10 and NDCG@10</span></span></li><li id="https://www.notion.so/c48440e7c9c94b36915d25aec41c823b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">4 negative samples for each positive one</span></span></li></ul><div id="https://www.notion.so/bbbecb4b3986453e88b6867a56cee084" class="Image Image--Normal"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F75cb468f-27b1-4a22-918a-50f3da9b155f%2FUntitled.png?width=354&amp;table=block&amp;id=bbbecb4b-3986-453e-88b6-867a56cee084"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F75cb468f-27b1-4a22-918a-50f3da9b155f%2FUntitled.png?width=354&amp;table=block&amp;id=bbbecb4b-3986-453e-88b6-867a56cee084" style="width:354px"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/85d8f9c698e74696bfbc4df74f2f3719" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Average epoch time is 90 seconds on Nvidia T4 GPU. Both hit_rate and ndcg values improves initially for first 4 epochs and then converged to a local (or global, I hope) minima.</span></span></p></div><div id="https://www.notion.so/ac63f061b1714d24aa4af41f9bd8bc53" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The complete tutorial (+code) can be foundÂ </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://sparsh-ai.github.io/rec-tutorials/matrixfactorization%20movielens%20pytorch%20scratch/2021/04/21/rec-algo-ncf-pytorch-pyy0715">here</a></span><span class="SemanticString">.</span></span></p></div></article>  <footer class="Footer">
        <div>&copy; RecoChef 2021</div>
        <div>&centerdot;</div>
        <div>Powered by <a target="_blank" href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>