<!DOCTYPE html>
<html lang="en">

<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-5F9Y9HC95G"></script>
      <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "G-5F9Y9HC95G");
      </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- iOS Safari -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Chrome, Firefox OS and Opera Status Bar Color -->
  <meta name="theme-color" content="#FFFFFF">
  <meta property="og:title" content="Brandless">
    <meta property="og:type" content="blog">
  <title>Brandless</title>
<link rel="icon" type="image/png" href="./favicon.png"/>
  <!-- Favicon -->
    <link rel="shortcut icon" target="_blank" href="ðŸŒ€">
    <link rel="stylesheet" type="text/css" target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
  <link rel="stylesheet" type="text/css"
    target="_blank" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/SourceSansPro.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/notablog.css">
  <link rel="stylesheet" type="text/css" target="_blank" href="css/theme.css">
  <style>
    :root {
      font-size: 18px;
    }

    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
    <a href="index">
      <div class="Navbar__Btn"><span>ðŸŒ€</span> <span>Home</span></div>
    </a>
                                                                                                                                                                              </nav>
  <header class="Header">
          <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
        <h1 class="Header__Title">Brandless</h1>
          </header>
      <article id="https://www.notion.so/8dd084cb66e843e68719781ed45f882b" class="PageRoot"><div id="https://www.notion.so/74d3846cdf804380a074bc22073293f0" class="Image Image--PageWidth"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3ae818a8-8e06-4a01-b014-e0a60ba61293%2FUntitled.png?width=1999&amp;table=block&amp;id=74d3846c-df80-4380-a074-bc22073293f0"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3ae818a8-8e06-4a01-b014-e0a60ba61293%2FUntitled.png?width=1999&amp;table=block&amp;id=74d3846c-df80-4380-a074-bc22073293f0" style="width:100%"/></a><figcaption><span class="SemanticStringArray"><span class="SemanticString">End-to-end machine learning workflow at Brandless.</span></span></figcaption></figure></div><div id="https://www.notion.so/6d7cee9e1fc24259b23f01c42db40c99" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic">We pull a variety of data to train two separate models. One collaborative filter utilizing user-product purchase data (ALS on Apache Spark) and one content-based system using product metadata. Depending on the age of the product, we route between the two different models. Next, we calculate cosine similarities between the input and the available recommendations. Finally, we rank products based on similarity and other factors such as cross-category exposure.</em></span></span></p></div><div id="https://www.notion.so/76b76ac1e7e24d3abbc9d028f19aa595" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/b88e3c6c8e6e44f7b3c1cc2987e6fc50" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/b88e3c6c8e6e44f7b3c1cc2987e6fc50"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Technology Stack</span></span></h2><div id="https://www.notion.so/66dbd4903c52446ca3bcdcc6cc578eb3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Brandless has a relatively small (and highly utilized) engineering team, so we needed a system that could be built and maintained by the data team. We had a fairly straightforward list of requirements:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/58c703140bfb4e87ab81b4139fdf87a4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Easy sandbox to test a variety of models and complex pre- and post-processing.</span></span></li><li id="https://www.notion.so/b03a6c33858e4a7598c81accf1415056" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Model-management system to keep track of different model versions and iterations.</span></span></li><li id="https://www.notion.so/6df3f4cfa1114384a98e1dc200159d10" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Easy, engineering-minimal deployment capabilities.</span></span></li><li id="https://www.notion.so/da6de2e89fbd4297bdf09a7f5c9706c1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Simple A/B testing frameworks.</span></span></li><li id="https://www.notion.so/e9ad6f21ed4e4cd281508578f9e441b9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">Open-source software that we could contribute back to in the future (if possible).</span></span></li></ul><div id="https://www.notion.so/7cc1f4f194694dd3998de3118532d421" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/0e765712105d4ad8ba1814cd229c60ba" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">After exploring a variety of different systems and tools, we landed on the following toolkit:</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/fd5cde2eba5c4e3fa9a1541b6d4fb68c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://databricks.com/product/unified-analytics-platform"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Databricks Unified Analytics Platform</strong></a></span><span class="SemanticString">: To develop, iterate, and test custom-built models.</span></span></li><li id="https://www.notion.so/8fcfb919250c41a4a84c5c715e96fd4a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://mlflow.org/"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">MLflow</strong></a></span><span class="SemanticString">: To log models and metadata, compare performance, and deploy to production.</span></span></li><li id="https://www.notion.so/98dae7503f0547308c39da6cfc24547a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://aws.amazon.com/sagemaker/#"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Amazon Sagemaker</strong></a></span><span class="SemanticString">: To host production models and run A/B tests on different models.</span></span></li></ul><div id="https://www.notion.so/2c02bcaa46834d2ca636e1f53449231d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/ffc453f1f6a44b15b330c5073455c8fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">The solution feeds raw data from Amazon Redshift to Databricks Unified Analytics Platform, which trains recommendation system models and develop custom pre and post-processing logic. We use the Databricks notebook functionality to collaborate in real time on model development and logic. We also performs a bit of offline testing within the Databricks platform.</strong></span></span></p></div><div id="https://www.notion.so/315c6d2460eb4c37a3a37c6c60d4ed43" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Next we push the data to our MLflow tracking server, which acts as a source of truth for our models. MLflow will store the model hyperparameters, metadata as well as actual model artifacts. Once we have two different models sitting on the tracking server, we use the MLflow deploy commands to push these models into Amazon Sagemaker.</strong></span></span></p></div><div id="https://www.notion.so/393ea34d1a9a4088be78b4d8cec3c176" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Our environment is stored in a Docker container, and the custom-packaged model pipeline is sent into Amazon Sagemakerâ€™s inference platform. This final step also enables us to run multiple models in parallel, as shown below.</strong></span></span></p></div><div id="https://www.notion.so/231cfd9fda3a461baf45608bb691f2f1" class="Image Image--PageWidth"><figure><a target="_blank" href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4f580cd0-4123-4803-b2a4-737ee9bb4cac%2FUntitled.png?width=1999&amp;table=block&amp;id=231cfd9f-da3a-461b-af45-608bb691f2f1"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F4f580cd0-4123-4803-b2a4-737ee9bb4cac%2FUntitled.png?width=1999&amp;table=block&amp;id=231cfd9f-da3a-461b-af45-608bb691f2f1" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/7237dc1ded734ac3b246c1b23d91d12d" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/7a98bed6ea484488833b1ab8ff17940b" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Once we have pushed a model to production with Amazon SageMaker, we can use the A/B testing functionality to iterate through different models and understand which version performs best. We will push two different model variants to a single endpoint and use the UpdateEndpointWeightsAndCapacities functionality to set specific weights to each model variant. Users on </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="http://brandless.com/">Brandless.com</a></span><span class="SemanticString"> will now be assigned model variants in a random occurrence. We record which variant each user receives as well as the actions taken after the recommendation system displays for the customer. Finally, we calculate model performance for each variant.</span></span></p></div><h2 id="https://www.notion.so/b1de028973534646b5275b0b458fc1cd" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/b1de028973534646b5275b0b458fc1cd"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Discussion</span></span></h2><div id="https://www.notion.so/053d72aa7832459889ab88a351d0783c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Now that Brandless has been using the Databricks-MLflow-Amazon SageMaker combination, the deployment process has evolved and become more efficient over time.</span></span></p></div><div id="https://www.notion.so/3a2884f891a04673979c6a4eebb69a77" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">It originated as a process that required manual checks as we trained the model, pushed to MLflow, and deployed to Amazon SageMaker. We now have a one-click process that automatically checks for errors at each step. We run this process roughly once a week.</span></span></p></div><div id="https://www.notion.so/3fd275274acb4bedac91f8c270ce98e4" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Since our initial deployment, we have tested and iterated through approximately 10 different models in production. These versions have different model hyperparameters, utilize increasingly complex post-processing, or combine multiple models in a hierarchy.</span></span></p></div><div id="https://www.notion.so/c2e5ae7ee71a43f0b3a56926d4a8a453" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">We measure online performance by calculating the percentage of Brandless.com visitors that interact with our recommended product carousels. We have seen performance increases on all but one of these model versions, with an estimated 15% improvement overall in comparison to our original model.</span></span></p></div><div id="https://www.notion.so/6c6498ead10543e69a27893a738ccec3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">The team has also used the Databricks-MLflow-Amazon SageMaker combination to move faster with development for other ML models. These use cases range from customer service improvements to logistics optimization, and all of the models follow the same process.</span></span></p></div><h2 id="https://www.notion.so/774256f7ad4c4bcdaca97373ec444ba3" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/774256f7ad4c4bcdaca97373ec444ba3"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Challenges and Learnings</strong></span></span></h2><div id="https://www.notion.so/e8e5cdea159f4755ae76eb1bcd361435" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">We ran into a couple of challenges along the way! Below, we outline a few of these and what we learned:</strong></span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e4220af7987c4be2abccf4ec7313c0b4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Leave time for DevOps and bug fixes:Â </strong></span><span class="SemanticString">Whether we were setting up proper AWS permissions or debugging an issue while alpha testingÂ </span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" target="_blank" href="https://databricks.com/blog/2018/06/05/introducing-mlflow-an-open-source-machine-learning-platform"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">MLflow</strong></a></span><span class="SemanticString">, we needed to leave more time for general debugging the first time the system was set up. Each of the fixes and changes that we made apply to the system as a whole, meaning new models generally take less time from start to finish.</span></span></li><li id="https://www.notion.so/4d209528899c4a69bd90341512bbda9d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Optimize for latency</strong></span><span class="SemanticString">: When we first deployed our model, we saw latency above 500ms due to complex Spark operations. This was too slow for our use cases on Brandless.com. To handle this, we built a system that pre-computed model outputs, ultimately bringing latency down below 100ms. We now consider and plan for latency at the beginning of model development.</span></span></li><li id="https://www.notion.so/40afd20a1b6949adbb5024cc17c9b4de" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Dependency management</strong></span><span class="SemanticString">: Due to the variety of environments that our process uses (multiple systems executing code, different Spark clusters, etc..) we occasionally run into problems managing our library and dataset dependencies. To solve this problem, we wrap all of our custom code into a Python egg package and upload it into all systems. This creates an extra step and can cause confusion across egg versions, so we hope to implement a fully-integrated container system in the future.</span></span></li></ul><h2 id="https://www.notion.so/611194698e0b4aedac7a40fa3e78c5ea" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" target="_blank" href="#https://www.notion.so/611194698e0b4aedac7a40fa3e78c5ea"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Links &amp; References</span></span></h2><div id="https://www.notion.so/300f0fb4615c49d599710b500ddd54f1" class="Embed"><div class="Embed__Content"><div class="Embed__ResponsiveContainer" style="width:854px;padding-bottom:56.20608899297424%"><iframe src="https://www.youtube.com/embed/PV_dREVilwQ" sandbox="allow-scripts allow-popups allow-forms allow-same-origin" allowfullscreen=""></iframe></div></div><p class="Embed__Caption"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/58b2bedd11dc4e57b989ae0ac01da362" class="Bookmark"><a target="_blank" href="https://slacker.ro/2019/08/27/guest-blog-using-databricks-mlflow-and-amazon-sagemaker-at-brandless-to-bring-recommendation-systems-to-production/"><h5 class="Bookmark__Title">Guest Blog: Using Databricks, MLflow, and Amazon SageMaker at Brandless to Bring Recommendation Systems to Production</h5><p class="Bookmark__Desc">This is a guest blog from Adam Barnhard, Head of Data at Brandless, Inc., and Bing Liang, Data Scientist at Brandless, Inc. Launched in July 2017, Brandless makes hundreds of high-quality items, curated for every member of your family and room of your home, and all sold at more accessible price points than similar products on the market.</p><p class="Bookmark__Link">https://slacker.ro/2019/08/27/guest-blog-using-databricks-mlflow-and-amazon-sagemaker-at-brandless-to-bring-recommendation-systems-to-production/</p></a></div></article>  <footer class="Footer">
        <div>&copy; RecoChef 2021</div>
        <div>&centerdot;</div>
        <div>Powered by <a target="_blank" href="https://github.com/dragonman225/notablog" target="_blank"
            rel="noopener noreferrer">Notablog</a>.
        </div>
    </footer>
</body>

</html>